<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nearby Gyms | FitConnect</title>
    <link rel="stylesheet" href="/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      body {
        background: linear-gradient(to bottom, #2c3e50, #4ca1af);
        color: #fff;
        font-family: Arial, sans-serif;
      }
      header {
        text-align: center;
        padding: 2rem;
      }
      #gym-list {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
        padding: 2rem;
      }
      .gym-card {
        background-color: #f8f9fa;
        color: #333;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 1.5rem;
        width: 250px;
        text-align: center;
        transition: transform 0.2s;
      }
      .gym-card:hover {
        transform: translateY(-5px);
      }
      .card-icon {
        font-size: 2rem;
        color: #4ca1af;
        margin-bottom: 1rem;
      }
      #map {
        width: 100%;
        height: 400px;
        margin: 2rem auto;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Nearby Gyms</h1>
      <p>Finding gyms near your location...</p>
    </header>
    <main>
      <div id="gym-list">
        <!-- 헬스장 목록이 여기에 표시됩니다 -->
      </div>
      <div id="map"></div>
      <!-- 지도 표시 -->
    </main>

    <!-- Google Maps API 로드 -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCR_YT9dN3ei0ZBsiui-9UX8Vj6POVYEHQ&callback=initMap"
      async
      defer
    ></script>

    <script>
      // 지도 초기화 및 사용자 위치 처리
      function initMap() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };

              const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: userLocation,
              });

              new google.maps.Marker({
                position: userLocation,
                map: map,
                title: 'Your Location',
                icon: {
                  url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                },
              });

              fetchNearbyGyms(map, userLocation);
            },
            (error) => {
              console.error('Geolocation error:', error);
              alert('Location access denied. Showing default location.');
              const defaultLocation = { lat: 37.7749, lng: -122.4194 };

              const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: defaultLocation,
              });

              fetchNearbyGyms(map, defaultLocation);
            }
          );
        } else {
          alert('Geolocation is not supported by this browser.');
        }
      }

      // 서버에서 헬스장 데이터를 가져와 지도 및 목록에 표시
      function fetchNearbyGyms(map, location) {
        const { lat, lng } = location;
        const requestUrl = `/home/api/nearby-gyms?lat=${lat}&lng=${lng}`;

        fetch(requestUrl)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((gyms) => {
            displayGyms(gyms); // 헬스장 목록 표시
            addGymMarkers(map, gyms); // 지도에 마커 추가
          })
          .catch((error) => console.error('Fetch Error:', error));
      }

      // 지도에 헬스장 마커 추가
      function addGymMarkers(map, gyms) {
        gyms.forEach((gym) => {
          const marker = new google.maps.Marker({
            position: {
              lat: gym.geometry.location.lat,
              lng: gym.geometry.location.lng,
            },
            map: map,
            title: gym.name,
          });

          const infoWindow = new google.maps.InfoWindow({
            content: `<div>
              <h2>${gym.name}</h2>
              <p>${gym.vicinity}</p>
              ${
                gym.rating
                  ? `<p>Rating: ${gym.rating} ⭐</p>`
                  : '<p>No rating available</p>'
              }
            </div>`,
          });

          marker.addListener('click', () => {
            infoWindow.open(map, marker);
          });
        });
      }

      // 헬스장 목록 표시
      function displayGyms(gyms) {
        const gymList = document.getElementById('gym-list');
        if (gyms.length === 0) {
          gymList.innerHTML = '<p>No gyms found nearby.</p>';
          return;
        }

        gymList.innerHTML = gyms
          .map(
            (gym) => `
              <div class="gym-card">
                <i class="fas fa-dumbbell card-icon"></i>
                <h2>${gym.name}</h2>
                <p>${gym.vicinity}</p>
                ${gym.rating ? `<p>Rating: ${gym.rating} ⭐</p>` : ''}
              </div>
            `
          )
          .join('');
      }
    </script>
  </body>
</html>
